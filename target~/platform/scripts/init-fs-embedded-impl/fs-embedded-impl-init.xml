<?xml version="1.0" encoding="UTF-8"?>
<!--
  	ANT
 
  	Copyright 2013-2016 IS2T. All rights reserved.
	Modification and distribution is permitted under certain conditions.
  	IS2T PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->
<project name="fsEmbeddedImplInit">

	<dirname property="ant.dir.fsEmbeddedImplInit" file="${ant.file.fsEmbeddedImplInit}"/>
	<import file="${ant.dir.fsEmbeddedImplInit}/../extension-init.xml" />
	
	<property name="fs.embedded.java.properties.prefix" value="com.is2t.fs.embedded.java."/>
	
	<target name="context/fs-embedded" extensionOf="init/context">
		<!-- Check if application attempts to use FS -->
		<available classpath="${application.classpath}" classname="com.is2t.java.io.IFileSystem" property="usesFSEMBEDDED"/>
	</target>
			
	<target name="init/fs/impl" extensionOf="init/execution" if="usesFSEMBEDDED">
	
		<!--  Augment the classpath with the classes used by FS -->
		<fail unless="platform.dir"/>
		<augment id="init.application.classpath">
			<fileset dir="${platform.dir}/javaLibs" includes="fs-*.jar"/>
			<fileset dir="${platform.dir}/javaLibs" includes="ej.components-*.jar"/>
			<fileset dir="${platform.dir}/javaLibs" includes="sni-*.jar"/>
		</augment>
		
		<property name="fs.embedded.resources.properties.prefix" value="com.is2t.fs.embedded.resources."/>
			
		<!--  Load the property file that was created during platform construction -->
		<property file="${ant.dir.fsEmbeddedImplInit}/fs.properties" prefix="${fs.embedded.java.properties.prefix}"/>
		
		<!-- Checks on mandatory Java properties -->
		<fail unless="com.is2t.fs.embedded.java.root.dir" message="Property 'root.dir' not specified in '${ant.dir.fsEmbeddedImplInit}/fs.properties' file."/>
		<fail unless="com.is2t.fs.embedded.java.user.dir" message="Property 'user.dir' not specified in '${ant.dir.fsEmbeddedImplInit}/fs.properties' file."/>
		<fail unless="com.is2t.fs.embedded.java.java.io.tmpdir" message="Property 'java.io.tmpdir' not specified in '${ant.dir.fsEmbeddedImplInit}/fs.properties' file."/>
		<fail unless="com.is2t.fs.embedded.java.file.separator" message="Property 'file.separator' not specified in '${ant.dir.fsEmbeddedImplInit}/fs.properties' file."/>
		<fail unless="com.is2t.fs.embedded.java.path.separator" message="Property 'path.separator' not specified in '${ant.dir.fsEmbeddedImplInit}/fs.properties' file."/>
		
		<!-- Make sure that the property is correctly set. If this fails, it means the platform has been badly constructed -->
		<fail unless="${fs.embedded.java.properties.prefix}com.is2t.java.io.IFileSystem" >
			The property "com.is2t.java.io.IFileSystem" must be set and contains a valid class name.
			Platform is probably corrupted. Please check FS module configuration and rebuild the platform.
		</fail>

		<!-- Add this class to the required type -->
		<augment id="init.requires">
			<string value="com.is2t.java.io.IFileSystem"/>
			<string value="${com.is2t.fs.embedded.java.com.is2t.java.io.IFileSystem}"/>
		</augment>
		
		<!--fs embedded java properties (user.dir, root.dir...)-->
		<augment id="init.properties">
			<propertyref prefix="${fs.embedded.java.properties.prefix}"/>
			<globmapper from="${fs.embedded.java.properties.prefix}*" to="*"/>
		</augment>
		
		<!--fs embedded immortal resource buffers properties (com.is2t.fs.embedded.resources.io.rw.buffer.size...)-->
		<augment id="init.properties">
			<propertyref prefix="${fs.embedded.resources.properties.prefix}"/>
		</augment>
	</target>
	
</project>